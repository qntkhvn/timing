---
title: |
  | STRAVA: <u>S</u>NAP <u>T</u>IMING <u>R</u>HYTHM, <u>A</u>DAPTABILITY & <u>VA</u>RIABILITY
output: 
  html_document: 
    math_method: katex
    number_sections: true
---

```{r}
#| include: false
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center"
)
```

---

# Introduction

Consider the following two pass attempts by Kansas City Chiefs quarterback Patrick Mahomes in the 2022 NFL regular season.
The first play (left) is a 9-yard pass to WR Marquez Valdes-Scantling for a first down during Colts vs Chiefs in week 3.
The second play (right) is a 45-yard TD pass to WR JuJu Smith-Schuster against the 49ers in week 7.
In both plays, KC (in white) uses the same type of motion---glide, as the motion players (in gold) initially line up in an outside wide alignment before moving laterally toward the inside.

<br>

:::: {style="display: flex;"}
::: {}
<center>
<img src="../figures/kelce_motion.gif">
</center>
:::
::: {}
<center>
<img src="../figures/hardman_motion.gif">
</center>
:::
::::

In each figure, the solid gold line along the motion player's path represents the trajectory portion between the start of motion and the ball-snap.
It is apparent that the plays differ in the duration of this color-coded portion of the path.
In the first play, the snap happens 3.6 seconds after Travis Kelce begins his motion, whereas in the second, less than a second elapses since Mecole Hardman starts motioning.
As both plays result in significant gains (1 first down and 1 TD), this highlights Mahomes' ability to anticipate, react, and time the snaps in various situations, elevating KC offense's effectiveness.

Thus, in every play, it is important for the quarterback to synchronize the snap with the team's offensive execution, in order to keep the defense off balance and offense in control.
In this work, we propose a multilevel modeling framework for evaluating a passer's ability to adapt and align the snap with their team's pre-snap motion, which culminates in a novel metric called STRAVA.

<!-- Story:  -->

<!-- higher variability = good?, give defense different looks -->

<!-- vs always the same time / low var -> figure out when snaps are gonna be -> not good? (more "predictable") -->

<!-- don't want defense to know when you're snapping -->

<!-- wanna be deceptive? -->

<!-- varying the amount of time between motion and snap -->

<!-- correlate -->

<!-- low var -> higher sack/havoc rate -> more vulnerable -->

<!-- low var: easier to predict when the snap will be -->


# Defining snap timing

We define the snap timing $\delta$ for a play as the number of frames elapsed between the start of motion $(t_{\text{motion}})$ and the ball-snap $(t_{\text{snap}})$.
That is,$$\delta = t_{\text{snap}} - t_{\text{motion}}\,.$$ 
Note that in our analysis, we only consider **plays with players in motion at snap and running a route**.

Here, it is straightforward to obtain $t_{\text{snap}}$ for each play using the frame label in the tracking data.
Conversely, identifying $t_{\text{motion}}$ requires more efforts, due to [inconsistency between player-level motion indicators and annotated tracking events](https://www.kaggle.com/competitions/nfl-big-data-bowl-2025/discussion/543709).

We use the following procedure to determine $t_{\text{motion}}$ for each play. 

*   For plays where the player in motion at snap is also the only player in motion since line-set, we use the `man_in_motion` event frame in the tracking data as the start of motion.

*   For the remaining plays (specifically, plays where motion player at snap is not the sole player in motion since line-set, and plays with players charted as in motion at snap but without a `man_in_motion` tracking event):

    *   We first observe the distribution for ratio between the speed at the `man_in_motion` event and the maximum speed between line-set and snap (only using plays with $t_{\text{motion}}$ identified earlier). 

    *   We then choose the average ratio value of 0.45 as the threshold for determining the start of motion for the remaining plays. Specifically, we assign $t_{\text{motion}}$ as the first frame between line-set and snap where the player reaches at least 45% of their top speed.


# Multilevel model for snap timing

The observed timing between motion and snap on a single play is surely attributable to numerous variables---from contextual and spatiotemporal features, to the players and teams involved.
To this end, we fit the following multilevel model:

\begin{align*}
  \delta_i  &\sim \textsf{Gamma}(\lambda_i, \phi_i) \\
  \log \lambda_i &=\alpha_{q[i],m[i],d[i]} + \boldsymbol{\beta X_i} \\
  \log \phi_i &=\alpha_{q[i]} \\
  \alpha_q  &\sim \textsf{Normal}(\mu_{\alpha_q}, \sigma^2_{\alpha_q}) && \small{\textrm{for quarterback}} &q &= 1, \dots, Q \\
  \alpha_m  &\sim \textsf{Normal}(\mu_{\alpha_m}, \sigma^2_{\alpha_m}) && \small{\textrm{for motion player}} &m &= 1, \dots, M \\
  \alpha_d  &\sim \textsf{Normal}(\mu_{\alpha_d}, \sigma^2_{\alpha_d}) && \small{\textrm{for defensive team}} &d &= 1, \dots, D \\
\end{align*}

In detail, we model the response $\delta_i > 0$ (snap timing for play $i$) with a Gamma distribution, which is well-suited for a positive, continuous variable like our case.

Of primary interest, we model the $\phi$ parameter, which represents the shape/variance of the distribution, with QB random effects.
This allows us to examine the variability in timing among NFL quarterbacks.
We hypothesize that a higher variability in timing is beneficial because it prevents defenses from predicting when the ball will be snapped.
This also allows the offense to control the game flow and exploit defensive vulnerabilities.

We also model the mean parameter $\lambda$ by including random intercepts for the quarterback, motion player, and defensive team.
Moreover, we account for contextual and personnel information about play $i$ through $\boldsymbol{X_i}$, and estimate the coefficients $\boldsymbol \beta$ as fixed effects.
These include the current down, number of timeouts remaining for the offense, play clock at the start of motion, motion player's position (WR, TE, RB/FB), and number of players in motion since line-set, as they all can impact the timing between motion and snap.
Another vital feature for modeling snap timing is the type of motion, since it relates to play design.
For instance, in a play-action pass, a team can fake a jet sweep to set up the QB for a pass.
This information, however, is not provided in the data, prompting us to consider a clustering algorithm to identify the motion types.

<!-- a team may employ the jet motion to bring a receiver from one side of the formation to the other to create a favorable matchup. -->

Our clustering input contains tracking data features describing the motion player's location at different events relative to the ball-snapper's location before the snap.
In particular, we compute the absolute difference in both horizontal (endzone) and vertical (sideline) directions between the motion player at the moment of snap and the snapper.
We also include the vertical displacement between the snapper and the motion player at both the start of motion and when they cross the line of scrimmage (LOS).
If the motion player never crosses LOS on a play, we instead use the location at either the QB event (e.g., forward pass, sack, fumble) or 3 seconds after the snap, depending on which happens sooner.
The aforementioned 3-second threshold is chosen using the observed distribution of the time elapsed from snap to crossing LOS for plays where motion players do cross LOS, as it captures a sufficiently large fraction (~95%) of the values.

<!-- 
I prefer "snapper" to "center" here 
-->

We use a Gaussian mixture model via the `mclust` `R` package to obtain unsupervised labels for the pre-snap motions.
We choose the optimal number of clusters using BIC (resulting in 7 clusters), and verify that the cluster assignments are reasonable by visualizing the motion trajectory of players in each cluster.


<!--
I'm putting limitations of this clustering approach in the discussion
-->

<!-- Still, this is just a starting point for identifying the different types of motion, as one could perform more sophisticated feature engineering or clustering algorithm to achieve more accurate cluster assignments. -->
<!-- Since designing the best clustering algorithm is not the main focus of our work, we leave this exploration for future work. -->

<!-- The focus of our approach is not in designing the best clustering algorithm; something reasonable should be enough. (verified with visual inspection...) -->

<!-- Our model-based clustering algorithm provides a reasonable starting point for identifying the different types of motion. -->




<!-- 
a finite mixture of 7 ellipsoidal multivariate Gaussian distributions with varying volume, shape, and orientation (VVV model)
Once the clusters are identified, we can the label the motion types to add more context to our cluster assignments.
-->

# Analysis

Our multilevel model is fitted in a Bayesian framework via the `brms` `R` package using 4 parallel chains, each having 10,000 iterations and 5,000 burn-in draws.
We perform diagnostics by computing the $\widehat R$ and effective sample size statistics and find no issues regarding model convergence and efficiency.
Ultimately, we obtain the posterior distributions for our model parameters and perform the following analysis, focusing on the shape/variance parameter.

The following figure displays the posterior distributions for the QB random intercept (ordered by posterior mean) for those with at least 50 pass attempts across the considered plays.
For each player, their posterior mean provides an estimate for their ability to maintain rhythm, adaptability and variability in snap timing, hence we call this metric **STRAVA**.
We see that Patrick Mahomes ranks first according to STRAVA, as his ability to time snaps stands out as another element to his success.
We also notice other high-caliber QBs such as Josh Allen and Tom Brady among the top players in our rankings.
Note that there is considerable uncertainty in our estimate, as indicated by the rather wide credible intervals, which is unsurprising given our limited sample of motion plays.

```{r}
#| fig-height: 8
#| fig-width: 6
readRDS("../figures/posteriors_slab.rds")
```

Next, we examine the relationship between the aforementioned QB posterior means (i.e. STRAVA) and a measure of "havoc rate". 
Here, a havoc event is defined as whether any of the following outcomes are generated on a play: pass breakup, forced fumble, tackle for loss, interception, sack, and pressure.
The figure below is a scatterplot of STRAVA and havoc rate for all passing plays (left) and only the considered motion plays (right) during the first nine weeks of the 2022 NFL regular season.
We observe that lower snap timing variability corresponds to higher rate of facing disruptive events created by the opposing defense.
This makes intuitive sense, as when there is little variability in timing, the offense is likely to be predictable and experience unfavorable play outcomes.
In contrast, by varying the timing, offenses can create uncertainty, forcing defenders to play more cautiously which reduces their effectiveness in executing disruptive plays.

```{r}
#| fig-height: 4.5
#| fig-width: 10
readRDS("../figures/corr_havoc.rds")
```

# Discussion

Variability in snap timing is an essential aspect for an offense to dictate a play and make it difficult for the defense to anticipate and react.
Through multilevel modeling, we have introduced STRAVA[^note], a measure of a quarterback's ability to maintain variable snap rhythm with their teammates' motion.
We demonstrate that higher variability in snap timing is beneficial for the passing game, as it is associated with experiencing less defensive disruptions.

Our proposed framework is not without limitations.
To identify the start of motion, we use a threshold-based criterion which relies only a fraction of a player's top speed prior to the snap.
This is certainly a simple viewpoint, as one could come up with a more rigid definition by building a model to predict the starting motion frame.
There may also be room for improvement in clustering the motion types by having more refined features (e.g., [[TODO: what are these?]]), or alternatively using a functional clustering approach.

[^note]: On a personal note, QN failed to convince RY to name the metric STRAIN (Mahomes' version), where STRAIN stands for Snap Timing Rhythm and Adaptability INdex.

# Appendix

All code is available at https://github.com/qntkhvn/timing.

---

[Quang Nguyen](https://github.com/qntkhvn) and [Ron Yurko](https://github.com/ryurko)

Department of Statistics & Data Science

Carnegie Mellon University